export DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
bash $DIR/del_cgroups

echo "Creating all cgroups"
mkdir /sys/fs/cgroup/cpuset/all
cat cpuset.mems > /sys/fs/cgroup/cpuset/all/cpuset.mems
echo "0-3" > /sys/fs/cgroup/cpuset/all/cpuset.cpus

mkdir /sys/fs/cgroup/memory/all
echo "8589934592" > /sys/fs/cgroup/memory/all/memory.limit_in_bytes

for group in cpuset memory; do
    echo "Moving processes to /sys/fs/cgroup/$group/all/"
    for task in `cat /sys/fs/cgroup/$group/tasks`; do
        echo $task > /sys/fs/cgroup/$group/all/tasks 2>/dev/null || \
	    echo "Unmovable: `cat /proc/$task/comm`";
    done
done


for cg in 0 1 2 3; do
    echo "Creating /sys/fs/cgroup/cpuset/ai$cg"
    mkdir /sys/fs/cgroup/cpuset/ai$cg
    cat cpuset.mems > /sys/fs/cgroup/cpuset/ai$cg/cpuset.mems
    echo "$((( 4 + 2 * cg )))-$((( 5 + 2*cg)))" > /sys/fs/cgroup/cpuset/ai$cg/cpuset.cpus
    echo 1 > /sys/fs/cgroup/cpuset/ai$cg/cpuset.cpu_exclusive
    
    echo "Creating /sys/fs/cgroup/memory/ai$cg"
    mkdir /sys/fs/cgroup/memory/ai$cg
    echo "6442450944" > /sys/fs/cgroup/memory/ai$cg/memory.limit_in_bytes
    echo 0 > /sys/fs/cgroup/memory/ai$cg/memory.swappiness
done
